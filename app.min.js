const httpServerAddr="http://on-air.fritz.box/api",webSocketServerAddr=window.location.host;let refreshQuery,webSocketUrl,state,webSocket;function establishWebSocketConnection(){webSocket=new WebSocket(webSocketUrl),webSocket.onopen=function(){console.debug("WebSocket connected.")},webSocket.onmessage=handleWebSocketMessage,webSocket.onclose=function(a){document.hidden||(console.debug("WebSocket is closed. Reconnect will be attempted in 1 second.",a.reason),setTimeout(function(){refreshState(),establishWebSocketConnection()},1e3))},webSocket.onerror=function(a){console.error("Closing socket due to error",a),disconnectWebSocket()}}function app(){state={mode:"off",temperature:0,zoom:{"alert-active":!1,"call-in-progress":!1}};const a="ontouchstart"in window||navigator.msMaxTouchPoints,b=a?"touchend":"click";$("random-pixels").addEventListener(b,randomPixels),$("clock").addEventListener(b,clock),$("marquee").addEventListener(b,marqueeMode),$("blank-display").addEventListener(b,blankDisplay),$("zoom-alert").addEventListener(b,toggleZoomAlert),$("keyboard").addEventListener(b,marqueeKeyboardInput),webSocketUrl="ws://"+webSocketServerAddr+":81",refreshQuery=new XMLHttpRequest,refreshState(),establishWebSocketConnection(),document.addEventListener("visibilitychange",onBrowserShownOrHidden),window.onunload=window.onbeforeunload=disconnectWebSocket()}function disconnectWebSocket(){webSocket.readyState===WebSocket.OPEN&&webSocket.close()}function onBrowserShownOrHidden(){document.hidden?disconnectWebSocket():(refreshState(),establishWebSocketConnection())}function handleWebSocketMessage(a){const b=JSON.parse(a.data);for(const c of Object.keys(b))state[c]=b[c];updateScreen()}function updateScreen(){const a=$("random-pixels"),b=$("clock"),c=$("marquee"),d=$("blank-display"),e=$("zoom-alert"),f=$("marquee-message");f.innerText=state.message,c.className="marquee"===state.mode?"row3col2 grid-box enabled":"row3col2 grid-box",b.className="clock"===state.mode?"row2col2 grid-box enabled":"row2col2 grid-box",a.className="random-pixels"===state.mode?"row2col1 grid-box enabled":"row2col1 grid-box",d.className="off"===state.mode?"row1col2 grid-box enabled":"row1col2 grid-box",e.innerHTML=state.zoom["alert-active"]?`<i class="fas fa-microphone-alt"></i>`:`<i class="fas fa-microphone-alt-slash"></i>`,e.className=state.zoom["call-in-progress"]?"row1col1 grid-box active":"row1col1 grid-box"}function refreshState(){refreshQuery=new XMLHttpRequest,refreshQuery.open("GET","http://on-air.fritz.box/api/status",!0),refreshQuery.onreadystatechange=function(){refreshQuery.readyState===XMLHttpRequest.DONE&&200===refreshQuery.status&&(state=JSON.parse(refreshQuery.responseText),updateScreen())},refreshQuery.send()}function marqueeKeyboardInput(){let a=prompt("Enter your message","");if(null==a||""==a)console.log("No user input");else{if(a=a.normalize("NFD").replace(/[\u0300-\u036f]/g,""),a=a.replace(/[^\x00-\x7F]/g,""),""==a)return void alert("Can't display that, sorry!");a=a.substring(0,255);const b=new XMLHttpRequest,c={value:a};b.open("PUT","http://on-air.fritz.box/api/message"),b.setRequestHeader("Content-Type","application/json"),b.send(JSON.stringify(c)),marqueeMode()}}function marqueeMode(){refreshQuery.abort();const a=new XMLHttpRequest;a.open("PUT","http://on-air.fritz.box/api/mode"),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify({name:"marquee"})),state.mode="marquee",updateScreen()}function randomPixels(){refreshQuery.abort();const a=new XMLHttpRequest;a.open("PUT","http://on-air.fritz.box/api/mode"),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify({name:"random-pixels"})),state.mode="random-pixels",updateScreen()}function clock(){refreshQuery.abort();const a=new XMLHttpRequest;a.open("PUT","http://on-air.fritz.box/api/mode"),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify({name:"clock"})),state.mode="clock",updateScreen()}function blankDisplay(){refreshQuery.abort();const a=new XMLHttpRequest;a.open("PUT","http://on-air.fritz.box/api/mode"),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify({name:"off"})),state.mode="off",updateScreen()}function toggleZoomAlert(){refreshQuery.abort();const a=new XMLHttpRequest;state.zoom["alert-active"]?a.open("DELETE","http://on-air.fritz.box/api/alert/zoom"):a.open("PUT","http://on-air.fritz.box/api/alert/zoom"),a.send(),state.zoom["alert-active"]=!state.zoom["alert-active"],updateScreen()}function $(a){return document.getElementById(a)}